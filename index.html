<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Carraro OS - Archive Complete</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        body { margin: 0; overflow: hidden; background-color: #000; font-family: 'Press Start 2P', cursive; }
        
        .scanlines {
            position: fixed; left: 0; top: 0; width: 100vw; height: 100vh;
            background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,0) 50%, rgba(0,0,0,0.05) 50%, rgba(0,0,0,0.05));
            background-size: 100% 4px; pointer-events: none; z-index: 50;
        }

        /* BOOT SCREEN */
        #boot-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: #000; z-index: 999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        #boot-log { 
            font-family: 'Press Start 2P', cursive; color: #44ff44; font-size: 12px;
            text-align: left; width: 680px; height: 400px; overflow: hidden; line-height: 2.0;
        }
        .log-line { margin-bottom: 5px; opacity: 0; animation: fadeIn 0.1s forwards; }
        @keyframes fadeIn { to { opacity: 1; } }

        #start-btn {
            margin-top: 20px; display: none;
            background: transparent; border: 2px solid #44ff44; color: #44ff44;
            padding: 15px 30px; font-family: 'Press Start 2P'; font-size: 14px; cursor: pointer;
            text-transform: uppercase; box-shadow: 0 0 10px #44ff44;
        }
        #start-btn:hover { background: #44ff44; color: #000; }

        #header {
            position: absolute; top: 20px; left: 20px; color: #44ff44; font-size: 10px; z-index: 10;
            pointer-events: none; text-shadow: 0 0 5px #44ff44; display: none;
        }

        /* MODALE */
        #product-modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.92); z-index: 100; align-items: center; justify-content: center;
        }
        .modal-content {
            background: #000; border: 2px solid #44ff44; box-shadow: 0 0 50px rgba(68, 255, 68, 0.4);
            padding: 30px; width: 85%; max-width: 750px; color: #44ff44; position: relative;
            display: flex; flex-direction: column; 
        }
        .modal-image-container { text-align: center; margin-bottom: 25px; border-bottom: 2px dashed #44ff44; padding-bottom: 25px; background: #051505;}
        .modal-image { width: 96px; height: 96px; image-rendering: pixelated; border: 2px solid #228822; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        #m-title { font-size: 16px; color: #fff; text-shadow: 2px 2px 0 #005500; line-height: 1.5; }
        #m-year { font-size: 10px; background: #004400; padding: 6px 10px; color: #fff; }
        .modal-body { font-size: 11px; line-height: 1.8; color: #ccffcc; font-family: 'Press Start 2P'; text-align: justify; }
        .close-btn {
            margin-top: 25px; width: 100%; padding: 15px; background: #003300; border: 1px solid #44ff44; 
            color: #44ff44; font-family: 'Press Start 2P'; cursor: pointer; text-transform: uppercase; font-size: 12px;
        }
        .close-btn:hover { background: #44ff44; color: #000; }
        canvas { cursor: crosshair; }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tween.js/18.6.4/tween.umd.js"></script>
</head>
<body>

    <div style="font-family: 'Press Start 2P'; opacity: 0; position: absolute;">.</div>

    <div id="boot-screen">
        <img src="twins.png" style="width: 280px; margin-bottom: 30px; image-rendering: pixelated;" alt="Twins">
        <div id="boot-log"></div>
        <button id="start-btn" onclick="startSystem()">[ ACCEDI ALL'ARCHIVIO ]</button>
    </div>
    <audio id="bg-music" loop><source src="music.mp3" type="audio/mpeg"></audio>
    <div class="scanlines"></div>
    <div id="header">MOVE MOUSE TO EXPLORE // CLICK TO SELECT</div>

    <div id="product-modal">
        <div class="modal-content">
            <div class="modal-image-container"><img id="m-image" class="modal-image" src="" alt="Icon"></div>
            <div class="modal-header"><span id="m-title">TITLE</span><span id="m-year">2000</span></div>
            <div id="m-desc" class="modal-body">Description...</div>
            <button class="close-btn" onclick="closeModal()">[ CHIUDI SCHEDA ]</button>
        </div>
    </div>

    <script>
        // --- ASSETS ---
        function generateRetroImage(type) {
            const c = document.createElement('canvas'); c.width = 64; c.height = 64; const ctx = c.getContext('2d');
            ctx.fillStyle = "#051105"; ctx.fillRect(0,0,64,64); ctx.fillStyle = "#44ff44"; 
            if(type==='cd'){ ctx.beginPath(); ctx.arc(32,32,25,0,6.28); ctx.fill(); ctx.fillStyle="#000"; ctx.beginPath(); ctx.arc(32,32,8,0,6.28); ctx.fill(); }
            else if(type==='vr'){ ctx.fillRect(10,20,44,24); ctx.fillStyle="#000"; ctx.fillRect(15,25,14,14); ctx.fillRect(35,25,14,14); }
            else if(type==='tab'){ ctx.fillRect(12,10,40,44); ctx.fillStyle="#000"; ctx.fillRect(16,14,32,36); }
            else if(type==='logo'){ ctx.font="40px monospace"; ctx.fillText("C",20,45); ctx.strokeRect(5,5,54,54); }
            else { ctx.fillRect(20,10,24,44); ctx.fillStyle="#000"; ctx.fillRect(24,15,16,5); ctx.fillRect(24,25,16,5); }
            return c.toDataURL();
        }
        const assets = { cd: generateRetroImage('cd'), vr: generateRetroImage('vr'), tab: generateRetroImage('tablet'), logo: generateRetroImage('logo'), file: generateRetroImage('file') };

        const archiveWords = ["M9 Museum", "Brixia Time Machine", "Cenacolo Vinciano", "Tharros", "Bibleworld", "Museo Egizio", "Valle dei Templi", "Arena Verona", "Matera Sassi", "Teatro La Fenice", "Duomo Milano", "Parco Leonardo", "Immersive Academia", "Palazzo Reale", "Street View 2006", "Leonardo", "Dante", "Giotto", "Pompei", "Venezia", "Milano"];

        // --- SCENE CONFIG ---
        const SCENES = {
            "HOME": [
                { text: "CHI SIAMO", target: "CHI_SIAMO", x: 0, y: 15, z: 0, color: "#44ff44", scale: 2.0 },
                { text: "COSA FACCIAMO", target: "COSA_FACCIAMO", x: -40, y: 0, z: 0, color: "#44ff44", scale: 2.0 },
                { text: "PRODOTTI", target: "PRODOTTI", x: 0, y: -15, z: 0, color: "#44ff44", scale: 2.0 },
                { text: "VISION", target: "VISION", x: 40, y: 0, z: 0, color: "#44ff44", scale: 2.0 }
            ],
            "CHI_SIAMO": [
                { text: "< HOME", target: "HOME", x: 0, y: 35, z: 0, color: "#ff4444", scale: 1.5 },
                { text: "GUALTIERO", x: -25, y: 0, z: 0, color: "#00ffff", scale: 1.5, details: {
                    year:"FOUNDER", image:assets.logo, tech:"STRATEGY",
                    desc:"Gualtiero Carraro.\n\nImprenditore digitale e pioniere della multimedialità in Europa. Ha guidato lo sviluppo di oltre 152 opere multimediali e ottenuto 11 premi internazionali, tra cui il prestigioso Premio Moebius."} 
                },
                { text: "ROBERTO", x: 25, y: 0, z: 0, color: "#00ffff", scale: 1.5, details: {
                    year:"FOUNDER", image:assets.logo, tech:"DEV",
                    desc:"Roberto Carraro.\n\nAutore multimediale e docente all'Accademia di Brera. Inventore di tecnologie brevettate come il 'Bubble Viewer' per la visualizzazione immersiva su tablet e smartphone."} 
                }
            ],
            "COSA_FACCIAMO": [
                { text: "< HOME", target: "HOME", x: 0, y: 35, z: 0, color: "#ff4444", scale: 1.5 },
                { text: "VR / AR", x: -25, y: 0, z: 0, color: "#ff00ff", scale: 1.5, details: {
                    year:"XR", image:assets.vr, tech:"VR",
                    desc:"Sviluppo di ambienti immersivi e musei virtuali. Dalle prime ricostruzioni della Roma Antica alle installazioni phygital per M9 e Palazzo Reale. Leader nella Realtà Virtuale e Aumentata."} 
                },
                { text: "AI GEN", x: 25, y: 0, z: 0, color: "#ff00ff", scale: 1.5, details: {
                    year:"AI", image:assets.logo, tech:"GPT",
                    desc:"Intelligenza Artificiale Generativa applicata alla cultura. Sviluppo di assistenti virtuali, generazione automatica di contenuti storici e piattaforme per la Scuola 4.0."} 
                }
            ],
            "VISION": [
                { text: "< HOME", target: "HOME", x: 0, y: 40, z: 0, color: "#ff4444", scale: 1.5 },
                
                { text: "NEURAL UI", x: 0, y: 0, z: 0, color: "#ffffff", scale: 1.5, details: {
                    year:"R&D", image:assets.vr, tech:"BCI",
                    desc:"Interfacce Neurali (BCI).\n\nOltre il touch screen: la ricerca di Carraro Lab esplora il controllo diretto dei dispositivi tramite onde cerebrali, aprendo nuove frontiere per l'accessibilità e l'interazione uomo-macchina."} 
                },
                
                { text: "AI ETHICS", x: -35, y: -15, z: 0, color: "#ffffff", scale: 1.5, details: {
                    year:"ETHICS", image:assets.logo, tech:"HUMANISM",
                    desc:"Umanesimo Digitale.\n\nL'impegno per un'Intelligenza Artificiale etica e sostenibile. Aderiamo ai principi del Manifesto di Vienna per garantire che la tecnologia rimanga al servizio dell'uomo e della cultura."} 
                },
                
                { text: "SPATIAL WEB", x: 35, y: -15, z: 0, color: "#ffffff", scale: 1.5, details: {
                    year:"WEB3", image:assets.tab, tech:"XR",
                    desc:"Spatial Computing e Web 3.0.\n\nIl passaggio da internet bidimensionale a spazi digitali tridimensionali e persistenti. Creazione di metaversi interoperabili e standard aperti per il futuro della rete."} 
                }
            ],
            "PRODOTTI": [] 
        };

        // --- GENERATORE NUVOLA FIBONACCI ---
        function generateProductSphere() {
            const items = [];
            items.push({ text: "< HOME", target: "HOME", x: 0, y: 35, z: -10, color: "#ff4444", scale: 1.8 });

            const heroes = [
                {
                    t:"OMNIA", y:"1996-2005", i:assets.cd, tech:"HERO",
                    d:"OMNIA - ENCICLOPEDIA MULTIMEDIALE\n\nLa più grande enciclopedia digitale realizzata in Europa, edita da De Agostini. Un best-seller assoluto che ha segnato un'epoca. Vincitrice del 'Nastro d'Oro' e del 'Grand Prix Moebius' a Lugano."
                },
                {
                    t:"ROMA 3D", y:"2011", i:assets.tab, tech:"HERO",
                    d:"VIRTUAL HISTORY ROMA\n\nPresentata ufficialmente da Steve Jobs durante il Keynote Apple dell'iPad 2 (Marzo 2011) definendola 'Wonderful App'. Prima app al mondo a utilizzare il brevetto 'Bubble Viewer'."
                },
                {
                    t:"EXPO 2015", y:"2015", i:assets.vr, tech:"HERO",
                    d:"VIRTUAL EXPO MILANO\n\nLa piattaforma ufficiale di realtà virtuale di Expo 2015. Sviluppata in collaborazione con Dassault Systèmes. Primo utilizzo di massa dei visori Samsung Gear VR."
                },
                {
                    t:"EDULAB", y:"2022", i:assets.vr, tech:"HERO",
                    d:"XR EDULAB & CULTURA CAMPANIA\n\nEcosistema digitale per la Scuola 4.0. Vincitore del 'Premio Moebius 2022' come miglior Metaverso editoriale. Include laboratori di Time Travel e aule immersive."
                },
                {
                    t:"iHERITAGE", y:"2021-23", i:assets.tab, tech:"HERO",
                    d:"UNESCO iHERITAGE\n\nProgetto strategico ICT Mediterranean (ENI CBC MED). Valorizzazione dei siti UNESCO in Sicilia, Spagna, Egitto, Giordania e Libano tramite tecnologie AR/VR."
                }
            ];
            
            heroes.forEach((h, i) => {
                const angle = (i / heroes.length) * Math.PI * 2;
                const radius = 40; 
                items.push({
                    text: h.t, x: Math.cos(angle)*radius, y: 0, z: Math.sin(angle)*radius, 
                    color: "#ffff00", scale: 1.6, 
                    details: {year:h.y, desc:h.d, tech:"HERO", image:h.i}
                });
            });

            const count = 45; 
            const radius = 60; 
            const goldenRatio = (1 + Math.sqrt(5)) / 2;

            for(let i=0; i<count; i++) {
                const label = archiveWords[i % archiveWords.length];
                const theta = 2 * Math.PI * i / goldenRatio;
                const phi = Math.acos(1 - 2 * (i + 0.5) / count);
                const x = Math.cos(theta) * Math.sin(phi) * radius;
                const y = Math.sin(theta) * Math.sin(phi) * radius;
                const z = Math.cos(phi) * radius;

                items.push({
                    text: label, x: x, y: y, z: z,
                    color: "#00aa00", scale: 1.0, 
                    details: {year:"ARCHIVE", desc:"Progetto storico dell'archivio Carraro Lab.", tech:"LEGACY", image:assets.file}
                });
            }
            return items;
        }
        SCENES["PRODOTTI"] = generateProductSphere();


        // --- ENGINE 3D ---
        let scene, camera, renderer, contentGroup, interactables = [];
        let raycaster, mouse = {x:0, y:0};
        let targetRotationX = 0, targetRotationY = 0;

        function init3D() {
            scene = new THREE.Scene(); 
            camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 1, 1000);
            camera.position.z = 0.1; 

            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);

            contentGroup = new THREE.Group();
            scene.add(contentGroup);

            const starGeo = new THREE.BufferGeometry();
            const starCount = 1000;
            const starArr = new Float32Array(starCount*3);
            for(let i=0; i<starCount*3; i++) starArr[i] = (Math.random()-0.5)*800;
            starGeo.setAttribute('position', new THREE.BufferAttribute(starArr,3));
            const stars = new THREE.Points(starGeo, new THREE.PointsMaterial({color:0x555555, size:0.5}));
            scene.add(stars);

            raycaster = new THREE.Raycaster();
            
            // LISTENERS
            window.addEventListener('mousemove', onMouseMove);
            
            // TOUCH LISTENERS AGGIUNTI
            window.addEventListener('touchstart', onTouchStart, {passive: false});
            window.addEventListener('touchmove', onTouchMove, {passive: false});

            window.addEventListener('click', onClick);
            window.addEventListener('resize', onResize);

            loadScene("HOME");
            animate();
        }

        function createLabel(data) {
            const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d');
            const fontSize = 32; 
            ctx.font = `${fontSize}px "Press Start 2P"`;
            const textWidth = ctx.measureText(data.text).width;
            
            canvas.width = textWidth + 40; canvas.height = fontSize + 40;
            
            ctx.fillStyle = "rgba(0,0,0,0.6)"; ctx.fillRect(0,0,canvas.width, canvas.height);
            ctx.font = `${fontSize}px "Press Start 2P"`; 
            ctx.fillStyle = data.color; ctx.textAlign = "center"; ctx.textBaseline = "middle";
            ctx.fillText(data.text, canvas.width/2, canvas.height/2);

            if (data.target || (data.details && data.details.tech==="HERO")) {
                ctx.strokeStyle = data.color; ctx.lineWidth = 4;
                ctx.strokeRect(4, 4, canvas.width-8, canvas.height-8);
            }

            const tex = new THREE.CanvasTexture(canvas); tex.minFilter = THREE.LinearFilter;
            const mat = new THREE.SpriteMaterial({ map: tex, transparent: true, opacity: 0 });
            const sprite = new THREE.Sprite(mat);
            
            const scaleFactor = 0.03; 
            const finalScale = scaleFactor * (data.scale || 1);
            
            sprite.scale.set(canvas.width*finalScale, canvas.height*finalScale, 1);
            sprite.position.set(data.x, data.y, data.z); 
            if(data.z === 0) sprite.position.z = -60;

            sprite.userData = { 
                target: data.target, details: data.details, text: data.text,
                baseScale: sprite.scale.clone(),
                origPos: sprite.position.clone()
            };
            return sprite;
        }

        function loadScene(name) {
            [...contentGroup.children].forEach(c => {
                new TWEEN.Tween(c.material).to({opacity:0}, 400).onComplete(()=>contentGroup.remove(c)).start();
                new TWEEN.Tween(c.scale).to({x:0, y:0}, 400).start();
            });
            interactables = [];
            setTimeout(() => {
                new TWEEN.Tween(contentGroup.rotation).to({x:0, y:0}, 1000).easing(TWEEN.Easing.Cubic.Out).start();
                SCENES[name].forEach((item, i) => {
                    const s = createLabel(item);
                    contentGroup.add(s); interactables.push(s);
                    new TWEEN.Tween(s.material).to({opacity:1}, 800).delay(i*20).start();
                });
            }, 500);
        }

        function onMouseMove(e) {
            if(isModalOpen) return;
            const mx = (e.clientX / window.innerWidth) * 2 - 1;
            const my = -(e.clientY / window.innerHeight) * 2 + 1;
            mouse.x = mx; mouse.y = my;
            targetRotationY = mx * 1.5; targetRotationX = -my * 1.0; 
        }

        // NUOVE FUNZIONI TOUCH
        function onTouchStart(e) {
             if(isModalOpen) return;
             if(e.touches.length > 0) {
                 const t = e.touches[0];
                 const mx = (t.clientX / window.innerWidth) * 2 - 1;
                 const my = -(t.clientY / window.innerHeight) * 2 + 1;
                 mouse.x = mx; mouse.y = my;
                 targetRotationY = mx * 1.5; targetRotationX = -my * 1.0;
             }
        }

        function onTouchMove(e) {
            if(isModalOpen) return;
            e.preventDefault(); // IMPORTANTE: Blocca lo scroll della pagina
            if(e.touches.length > 0) {
                const t = e.touches[0];
                const mx = (t.clientX / window.innerWidth) * 2 - 1;
                const my = -(t.clientY / window.innerHeight) * 2 + 1;
                mouse.x = mx; mouse.y = my;
                targetRotationY = mx * 1.5; targetRotationX = -my * 1.0; 
            }
        }

        let hoveredObj = null;
        const modal = document.getElementById('product-modal'); let isModalOpen = false;

        function openModal(title, d) {
            document.getElementById('m-title').innerText = title;
            document.getElementById('m-year').innerText = d.year;
            document.getElementById('m-desc').innerText = d.desc;
            document.getElementById('m-image').src = d.image;
            modal.style.display = 'flex'; isModalOpen = true;
        }
        window.closeModal = function() { modal.style.display = 'none'; isModalOpen = false; }

        function onClick(e) {
            if(isModalOpen || e.target.tagName !== 'CANVAS') return;
            if(hoveredObj) {
                if(hoveredObj.userData.target) loadScene(hoveredObj.userData.target);
                else if(hoveredObj.userData.details) openModal(hoveredObj.userData.text, hoveredObj.userData.details);
            }
        }

        function onResize(){
            camera.aspect = window.innerWidth/window.innerHeight; camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        const bootLogs = [
            "SYSTEM: CARRARO LAB ARCHIVE LOADING...", 
            "> PREMIO MOEBIUS LUGANO (CULTURA CAMPANIA)", 
            "> F@IMP 2.0 AWARD BUDAPEST", 
            "> UNITY AWARD SAN FRANCISCO (BEST NON-GAME)", 
            "> BEST IPAD APP 2011 (APPLE REWIND)", 
            "> PREMIO MOEBIUS INTERNATIONAL", 
            "> GRAND PRIX MOEBIUS (BIBLEWORLD)", 
            "> NASTRO D'ORO MOEBIUS (OMNIA)", 
            "DATABASE LOADED."
        ];

        window.onload = function() {
            document.fonts.ready.then(function () {
                const container = document.getElementById('boot-log'); let i = 0;
                function printLog() {
                    if(i < bootLogs.length) {
                        const div = document.createElement('div'); div.className = 'log-line'; div.innerText = bootLogs[i];
                        container.appendChild(div); i++; setTimeout(printLog, 250);
                    } else { document.getElementById('start-btn').style.display='inline-block'; }
                }
                setTimeout(printLog, 500);
            });
        }
        
        function startSystem() {
            document.getElementById('boot-screen').style.display='none';
            document.getElementById('header').style.display='block';
            let audio = document.getElementById('bg-music'); audio.volume=0.4; audio.play().catch(e=>{});
            init3D();
        }

        function animate(time) {
            requestAnimationFrame(animate); TWEEN.update(time);

            if(!isModalOpen && contentGroup) {
                contentGroup.rotation.y += (targetRotationY - contentGroup.rotation.y) * 0.05;
                contentGroup.rotation.x += (targetRotationX - contentGroup.rotation.x) * 0.05;

                raycaster.setFromCamera(mouse, camera);
                const intersects = raycaster.intersectObjects(interactables);

                if (hoveredObj && (!intersects.length || intersects[0].object !== hoveredObj)) {
                    new TWEEN.Tween(hoveredObj.scale).to({ x: hoveredObj.userData.baseScale.x, y: hoveredObj.userData.baseScale.y }, 200).start();
                    let c = 0x44ff44;
                    if(hoveredObj.userData.target === "HOME") c = 0xff4444;
                    else if(hoveredObj.userData.details && hoveredObj.userData.details.tech === "HERO") c = 0xffff00;
                    else if(hoveredObj.userData.details && hoveredObj.userData.details.tech === "LEGACY") c = 0x00aa00;
                    hoveredObj.material.color.setHex(c);
                    hoveredObj = null; document.body.style.cursor = 'default';
                }

                if (intersects.length > 0) {
                    const obj = intersects[0].object;
                    if (obj !== hoveredObj) {
                        hoveredObj = obj;
                        new TWEEN.Tween(obj.scale).to({ x: obj.userData.baseScale.x * 1.3, y: obj.userData.baseScale.y * 1.3 }, 200).start();
                        obj.material.color.set(0xffffff);
                        document.body.style.cursor = 'pointer';
                    }
                }
            }
            if(renderer && scene && camera) renderer.render(scene, camera);
        }
    </script>
</body>
</html>
