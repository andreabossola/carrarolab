<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, maximum-scale=1.0">
    <title>Carraro OS - Stable Restore</title>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <style>
        body { 
            margin: 0; overflow: hidden; background-color: #000; 
            font-family: 'Press Start 2P', cursive; 
            touch-action: none; -webkit-tap-highlight-color: transparent;
        }
        .scanlines {
            position: fixed; left: 0; top: 0; width: 100vw; height: 100vh;
            background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(255,255,255,0) 50%, rgba(0,0,0,0.05) 50%, rgba(0,0,0,0.05));
            background-size: 100% 4px; pointer-events: none; z-index: 50;
        }
        #boot-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: #000; z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        #boot-log { 
            font-family: 'Press Start 2P', cursive; color: #44ff44; font-size: 12px;
            text-align: left; width: 680px; max-width: 90%; height: 400px; overflow: hidden; line-height: 2.0;
            margin-top: 20px;
        }
        .log-line { margin-bottom: 5px; opacity: 0; animation: fadeIn 0.1s forwards; }
        @keyframes fadeIn { to { opacity: 1; } }
        
        #start-btn {
            margin-top: 20px; display: none;
            background: transparent; border: 2px solid #44ff44; color: #44ff44;
            padding: 15px 30px; font-family: 'Press Start 2P'; font-size: 14px; cursor: pointer;
            text-transform: uppercase; box-shadow: 0 0 10px #44ff44; pointer-events: auto;
        }
        #start-btn:hover { background: #44ff44; color: #000; }

        #header {
            position: absolute; top: 20px; left: 20px; color: #44ff44; font-size: 10px; z-index: 10;
            pointer-events: none; text-shadow: 0 0 5px #44ff44; display: none;
        }
        #product-modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.92); z-index: 2000; align-items: center; justify-content: center;
        }
        .modal-content {
            background: #000; border: 2px solid #44ff44; box-shadow: 0 0 50px rgba(68, 255, 68, 0.4);
            padding: 30px; width: 85%; max-width: 750px; color: #44ff44; position: relative;
            display: flex; flex-direction: column; z-index: 2001; 
        }
        .modal-image-container { text-align: center; margin-bottom: 25px; border-bottom: 2px dashed #44ff44; padding-bottom: 25px; background: #051505;}
        .modal-image { width: 96px; height: 96px; image-rendering: pixelated; border: 2px solid #228822; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        #m-title { font-size: 16px; color: #fff; text-shadow: 2px 2px 0 #005500; line-height: 1.5; }
        #m-year { font-size: 10px; background: #004400; padding: 6px 10px; color: #fff; }
        .modal-body { font-size: 11px; line-height: 1.8; color: #ccffcc; font-family: 'Press Start 2P'; text-align: justify; }
        .close-btn {
            margin-top: 25px; width: 100%; padding: 15px; background: #003300; border: 1px solid #44ff44; 
            color: #44ff44; font-family: 'Press Start 2P'; cursor: pointer; text-transform: uppercase; font-size: 12px;
        }
        canvas { display: block; position: absolute; top:0; left:0; z-index: 1; }
        
        #version-tag {
            position: fixed; bottom: 10px; right: 10px; background-color: #004400; color: #fff; padding: 5px;
            font-size: 10px; border: 1px solid #44ff44; z-index: 10000; pointer-events: none; opacity: 0.8;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tween.js/18.6.4/tween.umd.js"></script>
</head>
<body>

    <div id="boot-screen">
        <img src="twins.png" style="width: 280px; margin-bottom: 30px; image-rendering: pixelated;" alt="Twins">
        <div id="boot-log"></div>
        <button id="start-btn" onclick="startSystem()">[ ACCEDI ALL'ARCHIVIO ]</button>
    </div>
    
    <audio id="bg-music" loop><source src="music.mp3" type="audio/mpeg"></audio>
    <div class="scanlines"></div>
    <div id="header">DESKTOP: CLICK TO SELECT <br> MOBILE: DRAG TO MOVE</div>
    <div id="version-tag">RESTORED STABLE</div>

    <div id="product-modal">
        <div class="modal-content">
            <div class="modal-image-container"><img id="m-image" class="modal-image" src="" alt="Icon"></div>
            <div class="modal-header"><span id="m-title">TITLE</span><span id="m-year">2000</span></div>
            <div id="m-desc" class="modal-body">Description...</div>
            <button class="close-btn" onclick="closeModal()">[ CHIUDI SCHEDA ]</button>
        </div>
    </div>

    <script>
        (function updateTimestamp() {
            const now = new Date();
            const timeString = now.getHours().toString().padStart(2,'0') + ":" + now.getMinutes().toString().padStart(2,'0') + ":" + now.getSeconds().toString().padStart(2,'0');
            const tag = document.getElementById('version-tag');
            if(tag) tag.innerText = "RESTORED: " + timeString;
        })();

        // --- ASSETS ---
        function generateRetroImage(type) {
            const c = document.createElement('canvas'); c.width = 64; c.height = 64; const ctx = c.getContext('2d');
            ctx.fillStyle = "#051105"; ctx.fillRect(0,0,64,64); ctx.fillStyle = "#44ff44"; 
            if(type==='cd'){ ctx.beginPath(); ctx.arc(32,32,25,0,6.28); ctx.fill(); ctx.fillStyle="#000"; ctx.beginPath(); ctx.arc(32,32,8,0,6.28); ctx.fill(); }
            else if(type==='vr'){ ctx.fillRect(10,20,44,24); ctx.fillStyle="#000"; ctx.fillRect(15,25,14,14); ctx.fillRect(35,25,14,14); }
            else if(type==='tab'){ ctx.fillRect(12,10,40,44); ctx.fillStyle="#000"; ctx.fillRect(16,14,32,36); }
            else if(type==='logo'){ ctx.font="40px monospace"; ctx.fillText("C",20,45); ctx.strokeRect(5,5,54,54); }
            else { ctx.fillRect(20,10,24,44); ctx.fillStyle="#000"; ctx.fillRect(24,15,16,5); ctx.fillRect(24,25,16,5); }
            return c.toDataURL();
        }
        const assets = { cd: generateRetroImage('cd'), vr: generateRetroImage('vr'), tab: generateRetroImage('tablet'), logo: generateRetroImage('logo'), file: generateRetroImage('file') };
        const archiveWords = ["M9 Museum", "Brixia Time Machine", "Cenacolo Vinciano", "Tharros", "Bibleworld", "Museo Egizio", "Valle dei Templi", "Arena Verona", "Matera Sassi", "Teatro La Fenice", "Duomo Milano", "Parco Leonardo", "Immersive Academia", "Palazzo Reale", "Street View 2006", "Leonardo", "Dante", "Giotto", "Pompei", "Venezia", "Milano"];

        // --- SCENE CONFIG ---
        // RIPRISTINATE COORDINATE STANDARD (Non schiacciate)
        const SCENES = {
            "HOME": [
                { text: "CHI SIAMO", target: "CHI_SIAMO", x: 0, y: 15, z: 0, color: "#44ff44", scale: 2.5 }, 
                { text: "COSA FACCIAMO", target: "COSA_FACCIAMO", x: -40, y: 0, z: 0, color: "#44ff44", scale: 2.5 },
                { text: "PRODOTTI", target: "PRODOTTI", x: 0, y: -15, z: 0, color: "#44ff44", scale: 2.5 },
                { text: "VISION", target: "VISION", x: 40, y: 0, z: 0, color: "#44ff44", scale: 2.5 }
            ],
            "CHI_SIAMO": [
                { text: "< HOME", target: "HOME", x: 0, y: 35, z: 0, color: "#ff4444", scale: 2.5 },
                { text: "GUALTIERO", x: -25, y: 0, z: 0, color: "#00ffff", scale: 2.5, details: {year:"FOUNDER", image:assets.logo, tech:"STRATEGY", desc:"Gualtiero Carraro."} },
                { text: "ROBERTO", x: 25, y: 0, z: 0, color: "#00ffff", scale: 2.5, details: {year:"FOUNDER", image:assets.logo, tech:"DEV", desc:"Roberto Carraro."} }
            ],
            "COSA_FACCIAMO": [
                { text: "< HOME", target: "HOME", x: 0, y: 35, z: 0, color: "#ff4444", scale: 2.5 },
                { text: "VR / AR", x: -25, y: 0, z: 0, color: "#ff00ff", scale: 2.5, details: {year:"XR", image:assets.vr, tech:"VR", desc:"Ambienti immersivi."} },
                { text: "AI GEN", x: 25, y: 0, z: 0, color: "#ff00ff", scale: 2.5, details: {year:"AI", image:assets.logo, tech:"GPT", desc:"Intelligenza Artificiale."} }
            ],
            "VISION": [
                { text: "< HOME", target: "HOME", x: 0, y: 40, z: 0, color: "#ff4444", scale: 2.5 },
                { text: "NEURAL UI", x: 0, y: 0, z: 0, color: "#ffffff", scale: 2.5, details: {year:"R&D", image:assets.vr, tech:"BCI", desc:"Interfacce Neurali."} },
                { text: "AI ETHICS", x: -35, y: -15, z: 0, color: "#ffffff", scale: 2.5, details: {year:"ETHICS", image:assets.logo, tech:"HUMANISM", desc:"Umanesimo Digitale."} },
                { text: "SPATIAL WEB", x: 35, y: -15, z: 0, color: "#ffffff", scale: 2.5, details: {year:"WEB3", image:assets.tab, tech:"XR", desc:"Spatial Computing."} }
            ],
            "PRODOTTI": [] 
        };

        function generateProductSphere() {
            const items = [];
            items.push({ text: "< HOME", target: "HOME", x: 0, y: 35, z: -10, color: "#ff4444", scale: 2.5 });
            const heroes = [
                { t:"OMNIA", y:"1996-2005", i:assets.cd, tech:"HERO", d:"OMNIA - ENCICLOPEDIA MULTIMEDIALE" },
                { t:"ROMA 3D", y:"2011", i:assets.tab, tech:"HERO", d:"VIRTUAL HISTORY ROMA" },
                { t:"EXPO 2015", y:"2015", i:assets.vr, tech:"HERO", d:"VIRTUAL EXPO MILANO" },
                { t:"EDULAB", y:"2022", i:assets.vr, tech:"HERO", d:"XR EDULAB" },
                { t:"iHERITAGE", y:"2021-23", i:assets.tab, tech:"HERO", d:"UNESCO iHERITAGE" }
            ];
            heroes.forEach((h, i) => {
                const angle = (i / heroes.length) * Math.PI * 2;
                items.push({ text: h.t, x: Math.cos(angle)*50, y: 0, z: Math.sin(angle)*50, color: "#ffff00", scale: 2.8, details: {year:h.y, desc:h.d, tech:"HERO", image:h.i} });
            });
            const count = 30; const radius = 70; 
            const goldenRatio = (1 + Math.sqrt(5)) / 2;
            for(let i=0; i<count; i++) {
                const label = archiveWords[i % archiveWords.length];
                const theta = 2 * Math.PI * i / goldenRatio;
                const phi = Math.acos(1 - 2 * (i + 0.5) / count);
                items.push({ text: label, x: Math.cos(theta)*Math.sin(phi)*radius, y: Math.sin(theta)*Math.sin(phi)*radius, z: Math.cos(phi)*radius, color: "#00aa00", scale: 1.5, details: {year:"ARCHIVE", desc:"Archivio.", tech:"LEGACY", image:assets.file} });
            }
            return items;
        }
        SCENES["PRODOTTI"] = generateProductSphere();

        // --- ENGINE 3D ---
        let scene, camera, renderer, contentGroup, interactables = [];
        let raycaster, mouse = {x: -1000, y: -1000}; 
        
        let targetRotationX = 0, targetRotationY = 0;
        let onPointerDownPointerX = 0, onPointerDownPointerY = 0;
        let onPointerDownLon = 0, onPointerDownLat = 0;
        let isUserInteracting = false;
        
        function init3D() {
            scene = new THREE.Scene(); 
            // CORREZIONE FONDAMENTALE: CAMERA INDIETRO (Z=100)
            camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 1, 1000);
            camera.position.z = 100; 
            camera.lookAt(0,0,0);
            
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            document.body.appendChild(renderer.domElement);

            contentGroup = new THREE.Group();
            scene.add(contentGroup);
            
            const starGeo = new THREE.BufferGeometry();
            const starArr = new Float32Array(3000);
            for(let i=0; i<3000; i++) starArr[i] = (Math.random()-0.5)*800;
            starGeo.setAttribute('position', new THREE.BufferAttribute(starArr,3));
            scene.add(new THREE.Points(starGeo, new THREE.PointsMaterial({color:0x555555, size:0.5})));

            raycaster = new THREE.Raycaster();
            
            document.addEventListener('touchstart', onTouchStart, {passive: false});
            document.addEventListener('touchmove', onTouchMove, {passive: false});
            document.addEventListener('touchend', onTouchEnd, {passive: false});
            document.addEventListener('mousemove', onMouseMove);
            document.addEventListener('mousedown', onMouseDown);
            document.addEventListener('mouseup', onMouseUp);
            window.addEventListener('resize', onResize);

            loadScene("HOME");
            animate();
        }

        // --- INPUT HANDLING RIPRISTINATO ---

        function onTouchStart(e) {
            if(isModalOpen) return;
            if(e.touches.length === 1) {
                isUserInteracting = true;
                onPointerDownPointerX = e.touches[0].clientX;
                onPointerDownPointerY = e.touches[0].clientY;
                onPointerDownLon = targetRotationY; 
                onPointerDownLat = targetRotationX;
            }
        }

        function onTouchMove(e) {
            if(isModalOpen || !isUserInteracting) return;
            e.preventDefault(); 
            
            const touchX = e.touches[0].clientX;
            const touchY = e.touches[0].clientY;
            const deltaX = touchX - onPointerDownPointerX;
            const deltaY = touchY - onPointerDownPointerY;

            if (Math.abs(deltaX) < 5 && Math.abs(deltaY) < 5) return;

            // Logica drag mobile
            targetRotationY = onPointerDownLon + deltaX * 0.005; 
            targetRotationX = onPointerDownLat + deltaY * 0.005; 
        }

        function onTouchEnd(e) {
            isUserInteracting = false;
            if(e.changedTouches.length > 0) {
                const t = e.changedTouches[0];
                const dist = Math.hypot(t.clientX - onPointerDownPointerX, t.clientY - onPointerDownPointerY);
                if(dist < 15) { 
                    mouse.x = (t.clientX / window.innerWidth) * 2 - 1;
                    mouse.y = -(t.clientY / window.innerHeight) * 2 + 1;
                    checkIntersection(true); 
                }
            }
        }

        function onMouseMove(e) {
            if(isModalOpen || isUserInteracting) return;
            const mx = (e.clientX / window.innerWidth) * 2 - 1;
            const my = -(e.clientY / window.innerHeight) * 2 + 1;
            mouse.x = mx;
            mouse.y = my;
            
            // LOGICA DESKTOP: SOLO PARALLASSE, NIENTE ROTAZIONE COMPLETA
            // Questo fa sÃ¬ che il mouse sia libero per cliccare
            targetRotationY = mx * 0.2; 
            targetRotationX = -my * 0.1; 
        }
        
        function onMouseDown(e) { isUserInteracting = true; }
        function onMouseUp(e) { 
            isUserInteracting = false; 
            if(e.button === 0) checkIntersection(true); 
        }

        function checkIntersection(isClick) {
            raycaster.setFromCamera(mouse, camera);
            const intersects = raycaster.intersectObjects(contentGroup.children); // Raycast sui figli ruotati
            
            if (intersects.length > 0) {
                const obj = intersects[0].object;
                if(!isClick) {
                    if(obj !== hoveredObj) {
                        if(hoveredObj) new TWEEN.Tween(hoveredObj.scale).to({x: hoveredObj.userData.baseScale.x, y: hoveredObj.userData.baseScale.y}, 200).start();
                        hoveredObj = obj;
                        new TWEEN.Tween(obj.scale).to({x: obj.userData.baseScale.x * 1.2, y: obj.userData.baseScale.y * 1.2}, 200).start();
                        document.body.style.cursor = 'pointer';
                    }
                } else {
                    if(obj.userData.target) loadScene(obj.userData.target);
                    else if(obj.userData.details) openModal(obj.userData.text, obj.userData.details);
                }
            } else {
                if(hoveredObj && !isClick) {
                     new TWEEN.Tween(hoveredObj.scale).to({x: hoveredObj.userData.baseScale.x, y: hoveredObj.userData.baseScale.y}, 200).start();
                     hoveredObj = null;
                     document.body.style.cursor = 'default';
                }
            }
        }
        let hoveredObj = null;

        function createLabel(data) {
            const canvas = document.createElement('canvas'); const ctx = canvas.getContext('2d');
            ctx.font = '32px "Press Start 2P"';
            const textWidth = ctx.measureText(data.text).width;
            canvas.width = textWidth + 40; canvas.height = 72; 
            
            ctx.fillStyle = "rgba(0,0,0,0.6)"; ctx.fillRect(0,0,canvas.width, canvas.height);
            ctx.font = '32px "Press Start 2P"'; 
            ctx.fillStyle = data.color; ctx.textAlign = "center"; ctx.textBaseline = "middle";
            ctx.fillText(data.text, canvas.width/2, canvas.height/2);

            if (data.target || (data.details && data.details.tech==="HERO")) {
                ctx.strokeStyle = data.color; ctx.lineWidth = 4;
                ctx.strokeRect(4, 4, canvas.width-8, canvas.height-8);
            }

            const tex = new THREE.CanvasTexture(canvas); 
            const mat = new THREE.SpriteMaterial({ map: tex, transparent: true, opacity: 0 });
            const sprite = new THREE.Sprite(mat);
            
            const scaleFactor = 0.03 * (data.scale || 1);
            sprite.scale.set(canvas.width*scaleFactor, canvas.height*scaleFactor, 1);
            
            sprite.position.set(data.x, data.y, data.z); 
            if(data.z === 0 && data.x === 0 && data.y !== 0) sprite.position.z = -50; 

            sprite.userData = { target: data.target, details: data.details, text: data.text, baseScale: sprite.scale.clone() };
            return sprite;
        }

        function loadScene(name) {
            new TWEEN.Tween(contentGroup.rotation).to({x:0, y:0}, 1000).start();
            targetRotationX = 0; targetRotationY = 0;

            [...contentGroup.children].forEach(c => {
                new TWEEN.Tween(c.material).to({opacity:0}, 300).onComplete(()=>contentGroup.remove(c)).start();
            });
            interactables = [];
            setTimeout(() => {
                SCENES[name].forEach((item, i) => {
                    const s = createLabel(item);
                    contentGroup.add(s); interactables.push(s); 
                    new TWEEN.Tween(s.material).to({opacity:1}, 600).delay(i*50).start();
                });
            }, 350);
        }

        const modal = document.getElementById('product-modal'); let isModalOpen = false;
        function openModal(title, d) {
            document.getElementById('m-title').innerText = title;
            document.getElementById('m-year').innerText = d.year;
            document.getElementById('m-desc').innerText = d.desc;
            document.getElementById('m-image').src = d.image;
            modal.style.display = 'flex'; isModalOpen = true;
        }
        window.closeModal = function() { modal.style.display = 'none'; isModalOpen = false; }
        
        const bootLogs = [
            "SYSTEM: CARRARO LAB ARCHIVE LOADING...", 
            "> PREMIO MOEBIUS LUGANO (CULTURA CAMPANIA)", 
            "> F@IMP 2.0 AWARD BUDAPEST", 
            "> BEST IPAD APP 2011 (APPLE REWIND)", 
            "> GRAND PRIX MOEBIUS (BIBLEWORLD)", 
            "DATABASE LOADED."
        ];
        window.onload = function() {
            document.fonts.ready.then(function () {
                const container = document.getElementById('boot-log'); let i = 0;
                function printLog() {
                    if(i < bootLogs.length) {
                        const div = document.createElement('div'); div.className = 'log-line'; div.innerText = bootLogs[i];
                        container.appendChild(div); i++; setTimeout(printLog, 300);
                    } else { document.getElementById('start-btn').style.display='inline-block'; }
                }
                setTimeout(printLog, 500);
            });
        }
        function startSystem() {
            document.getElementById('boot-screen').style.display='none';
            document.getElementById('header').style.display='block';
            let audio = document.getElementById('bg-music'); audio.volume=0.4; audio.play().catch(e=>{});
            init3D();
        }
        function onResize(){
            camera.aspect = window.innerWidth/window.innerHeight; camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }

        function animate(time) {
            requestAnimationFrame(animate); TWEEN.update(time);

            if(contentGroup) {
                contentGroup.rotation.y += (targetRotationY - contentGroup.rotation.y) * 0.1;
                contentGroup.rotation.x += (targetRotationX - contentGroup.rotation.x) * 0.1;
            }

            if(!isUserInteracting && !isModalOpen) checkIntersection(false);

            if(renderer && scene && camera) renderer.render(scene, camera);
        }
    </script>
</body>
</html>
